{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/lanalyse-syntaxique-a-la-rescousse","webpackCompilationHash":"95e3cffe7f071f082096","result":{"data":{"file":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQCAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABbM+6FcmUf//EABkQAAMBAQEAAAAAAAAAAAAAAAECAxEAIf/aAAgBAQABBQKbEimMGmmpQjt87//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/AVf/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwGI/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAERECH/2gAIAQEABj8CI8ihOZ//xAAaEAEAAwEBAQAAAAAAAAAAAAABABFBMVFh/9oACAEBAAE/IbQ89jStmzhRPRqQdkU+Euf/2gAMAwEAAgADAAAAEBgf/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAh/9oACAEDAQE/EDE//8QAFhEAAwAAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/EBS//8QAHRABAAICAgMAAAAAAAAAAAAAAQARITFBYYGhsf/aAAgBAQABPxAiicu0OpgoNwWlE6lGwptDitVfuJIQYuPqzLQHif/Z","aspectRatio":1.5,"src":"/static/4d39327e15ae1d91de36b479d0b25c78/9a396/analyse-syntaxique.jpg","srcSet":"/static/4d39327e15ae1d91de36b479d0b25c78/b5002/analyse-syntaxique.jpg 140w,\n/static/4d39327e15ae1d91de36b479d0b25c78/244c7/analyse-syntaxique.jpg 280w,\n/static/4d39327e15ae1d91de36b479d0b25c78/9a396/analyse-syntaxique.jpg 560w,\n/static/4d39327e15ae1d91de36b479d0b25c78/a3c0e/analyse-syntaxique.jpg 840w,\n/static/4d39327e15ae1d91de36b479d0b25c78/a0ef7/analyse-syntaxique.jpg 1120w,\n/static/4d39327e15ae1d91de36b479d0b25c78/81ef8/analyse-syntaxique.jpg 1200w","sizes":"(max-width: 560px) 100vw, 560px"}}},"markdownRemark":{"html":"<p>Un de mes clients, <a href=\"http://www.hiventy.com/\">hiventy</a>, a eu besoin d'ajouter sur une liste d'éléments un champ de recherche. Le but était simple : pouvoir filter les résultats affichés.</p>\n<p>La liste étant affichée grâce à react-virtualized, le filtrage se réalise uniquement côté client car de ce fait la performance n'est pas un problème.</p>\n<p>Afin d'obtenir une solution robuste et flexible, j'ai opté pour l'implémentation d'un couple lexeur/parseur afin de proposer une analyse syntaxique efficace.</p>\n<p>Trouvant le sujet très intéressant, j'ai eu envie de vous le faire découvrir.</p>\n<p><em>Note: Malgré un article en français, j'ai gardé quelques mots en anglais que je trouve plus adaptés, notamment les mots token et term</em></p>\n<h2>Le besoin</h2>\n<p>La requête que l'utilisateur va saisir dans le champ de recherche doit répondre à plusieurs critères :</p>\n<ul>\n<li>Une recherche de texte libre doit être possible (ex: <code class=\"language-text\">foo</code>)</li>\n<li>Une recherche par champ doit être possible (ex: <code class=\"language-text\">field:bar</code>)</li>\n<li>Une recherche par champ et en texte libre doit être possible (ex: <code class=\"language-text\">foo field:bar</code>)</li>\n<li>L'identifiant d'un champ doit pouvoir être recherché en tant que texte libre, autrement dit nous devons pouvoir échapper les <code class=\"language-text\">:</code> (ex: <code class=\"language-text\">field\\:</code>)</li>\n<li>Que ce soit pour le texte libre ou pour un champ, nous souhaitons supporter les expressions régulières</li>\n</ul>\n<h2>Transformer la requête en un tableau de tokens</h2>\n<p>L'analyse syntaxique se base sur deux niveaux d'abstraction : le lexeur et le parseur.\nC'est ce premier que nous allons d'abord implémenter. Son principe est simple, il prend en entrée une chaîne de caractère et retourne en sortie une suite de tokens. Prenons un exemple :</p>\n<p>Consérons l'entrée suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">foo bar:hello</code></pre></div>\n<p>La liste de tokens que nous nous attendons à recevoir est la suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">T<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">STRING(foo) T</span><span class=\"token punctuation\">_</span></span>SPACE T<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">STRING(bar) T</span><span class=\"token punctuation\">_</span></span>SYMBOL(:) T_STRING(hello)</code></pre></div>\n<p>Cette étape est cruciale car c'est elle qui va abstraire le format de la donnée d'entrée, permettant ainsi à notre parseur de ne manipuler que des structures connues.</p>\n<p>Nous avons maintenant notre entrée et notre sortie, il est temps de coder notre lexeur ! Nous avons premièrement besoin de quelques constantes et helpers afin de nous faciliter le boulot :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">T_STRING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'T_STRING'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">T_SYMBOL</span> <span class=\"token operator\">=</span> <span class=\"token string\">'T_SYMBOL'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">T_BOOLEAN</span> <span class=\"token operator\">=</span> <span class=\"token string\">'T_BOOLEAN'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">T_SPACE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'T_SPACE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">T_UNKNOWN</span> <span class=\"token operator\">=</span> <span class=\"token string\">'T_UNKNOWN'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isBoolean</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> input <span class=\"token operator\">===</span> <span class=\"token string\">'true'</span> <span class=\"token operator\">||</span> input <span class=\"token operator\">===</span> <span class=\"token string\">'false'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isSymbol</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\\\'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> type <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    value<span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nous définissons d'abord nos différents types de tokens, les autres fonctions sont quant à elles suffisament explicites. Comme vous l'avez remarqué nous aurons 3 caractères spéciaux (nommés symboles) : <code class=\"language-text\">:</code>, <code class=\"language-text\">/</code> et <code class=\"language-text\">\\</code>.</p>\n<p>Passons maintenant au coeur de notre lexeur :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createTokens</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> tokens <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> buffer <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// will be introduced later</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> input<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> char <span class=\"token operator\">=</span> input<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isSymbol</span><span class=\"token punctuation\">(</span>char<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      tokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token constant\">T_SYMBOL</span><span class=\"token punctuation\">,</span> char<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>char <span class=\"token operator\">===</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      tokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token constant\">T_SPACE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      buffer <span class=\"token operator\">+=</span> char<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> tokens<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Comme vous avez dû le remarquer, la fonction <code class=\"language-text\">flush()</code> est vide dans cet exemple, nous verrons son implementation par la suite.</p>\n<p>Essayons de comprendre ce bout de code :</p>\n<ul>\n<li>Notre fonction <code class=\"language-text\">createTokens()</code> reçoit notre requête en entrée.</li>\n<li>Elle initialise notre tableau de tokens et un buffer vide.</li>\n<li>\n<p>Nous bouclons ensuite sur tous les caractères de notre requête et nous y appliquons le raisonnement suivant :</p>\n<ul>\n<li>Si le caractère courant est un symbole, alors nous enregistrons le contenu actuel du buffer grâce à notre méthode <code class=\"language-text\">flush()</code> et ajoutons à notre tableau un nouveau token de type <code class=\"language-text\">T_SYMBOL</code> avec pour valeur notre caractère courant.</li>\n<li>Si le caractère courant est un espace, alors nous enregistrons le contenu actuel du buffer grâce à notre méthode <code class=\"language-text\">flush()</code> et ajoutons à notre tableau un nouveau token de type <code class=\"language-text\">T_SPACE</code>.</li>\n<li>Enfin dans tous les autres cas, nous ajoutons le caractère courant au buffer.</li>\n</ul>\n</li>\n<li>Enfin nous enregistrons le contenu resté dans le buffer et non traité grâce à notre méthode <code class=\"language-text\">flush()</code>.</li>\n<li>Nous retournons notre tableau de tokens.</li>\n</ul>\n<p>Cela est bien beau mais nous n'avons toujours pas pu voir ce que fait notre fameuse fonction <code class=\"language-text\">flush()</code> !</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>buffer<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isBoolean</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    tokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token constant\">T_BOOLEAN</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    tokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token constant\">T_STRING</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  buffer <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>De nouveau, essayons de comprendre ce bout de code :</p>\n<ul>\n<li>\n<p>Si le buffer est vide alors il n'y a rien à faire et nous sortons. Dans le cas contraire nous analysons le contenu du buffer :</p>\n<ul>\n<li>Si le contenu est un booléen nous ajoutons à notre tableau un token de type <code class=\"language-text\">T_BOOLEAN</code> avec pour valeur la valeur booléenne de notre buffer.</li>\n<li>Dans tous les autres cas nous créons un token de type <code class=\"language-text\">T_STRING</code> avec pour valeur le contenu de notre buffer.</li>\n</ul>\n</li>\n<li>Pour finir, nous vidons notre buffer.</li>\n</ul>\n<p>Nous avons donc une fonction <code class=\"language-text\">createTokens()</code> capable de transformer notre requête en tokens. Mais il nous manque toujours quelque chose, vous vous en souvenez ? Nous souhaitons pouvoir échapper nos <code class=\"language-text\">:</code> ou plus généralement nous souhaitons pouvoir échapper n'importe quel token de type <code class=\"language-text\">T_SYMBOL</code>.</p>\n<p>Le principe de l'échappement est simple :</p>\n<ul>\n<li>Si nous rencontrons deux tokens de type <code class=\"language-text\">T_SYMBOL</code> et que le premier contient comme valeur <code class=\"language-text\">\\</code> alors nous devons les fusionner en un seul token de type <code class=\"language-text\">T_STRING</code> ayant pour valeur la valeur de notre second token de type <code class=\"language-text\">T_SYMBOL</code>.</li>\n<li>Enfin nous repassons sur notre tableau de token et fusionnons tous les tokens de type <code class=\"language-text\">T_STRING</code> adjacents.</li>\n</ul>\n<p>Pour commencer, nous pouvons déjà ajouter un bout de code tout simple à la fin de notre fonction <code class=\"language-text\">createTokens()</code>, juste avant le <code class=\"language-text\">return</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> escaped <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>escaped<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> escapedTokens <span class=\"token operator\">=</span> <span class=\"token function\">escape</span><span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>escapedTokens<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;</span> tokens<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    tokens <span class=\"token operator\">=</span> escapedTokens<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    escaped <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Ce bout de code est tout simple, nous lançons une recherche d'échappement dans notre tableau de tokens. Si cela se produit, la taille de notre tableau va forcément diminuer. Tant que cela se reproduit nous continuons à lancer la recherche.</p>\n<p>Notre tableau de tokens de sortie est donc conforme à l'échappement souhaité une fois cette boucle terminée. C'est là l'avantage du lexeur, le parseur n'aura pas à se soucier de ces cas particuliers. Il n'aura à sa charge qu'à trouver une signification dans des ensembles de blocs logiques, ici nos tokens.</p>\n<p>Il nous reste donc une dernière étape concernant notre lexeur : notre fonction <code class=\"language-text\">escape()</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">escape</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tokens</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> escaping <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> escapedTokens <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> tokens<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">T_SYMBOL</span> <span class=\"token operator\">&amp;&amp;</span> token<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'\\\\'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>escaping<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      escaping <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">T_SYMBOL</span> <span class=\"token operator\">&amp;&amp;</span> escaping<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      escaping <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n      escapedTokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token constant\">T_STRING</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">T_SPACE</span> <span class=\"token operator\">&amp;&amp;</span> escaping<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      escaping <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n      escapedTokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token constant\">T_STRING</span><span class=\"token punctuation\">,</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>escaping<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        escapedTokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token constant\">T_STRING</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\\\'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      escapedTokens<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      escaping <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mergeStringTokens</span><span class=\"token punctuation\">(</span>escapedTokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Regardons de plus près ce bout de code :</p>\n<ul>\n<li>Notre fonction <code class=\"language-text\">escape()</code> reçoit en entrée notre liste de tokens, générée précédemment.</li>\n<li>Nous initialisons une variable <code class=\"language-text\">escaping</code> nous indiquant si nous sommes en train de traiter ou non un échappement, ainsi que le tableau de tokens dans lequel nous allons empiler nos tokens.</li>\n<li>\n<p>Nous parcourons ensuite notre tableau, afin de prendre une décision pour chaque token :</p>\n<ul>\n<li>Le token courant est de type <code class=\"language-text\">T_SYMBOL</code> et contient <code class=\"language-text\">\\</code> comme valeur ! Nous venons de détecter le début d'un échappement, nous mettons donc notre variable <code class=\"language-text\">escaping</code> à <code class=\"language-text\">true</code>.</li>\n<li>Le token courant est de type <code class=\"language-text\">T_SYMBOL</code> et nous sommes dans un échappement. Dans ce cas, nous réinitialisons notre variable <code class=\"language-text\">escaping</code> et nous ajoutons à notre tableau un token de type <code class=\"language-text\">T_STRING</code> avec comme valeur celle du token courant.</li>\n<li>Le token courant est de type <code class=\"language-text\">T_SPACE</code> et nous sommes dans un échappement. Dans ce cas, nous réinitialisons notre variable <code class=\"language-text\">escaping</code> et nous ajoutons à notre tableau un token de type <code class=\"language-text\">T_STRING</code> avec comme valeur un espace.</li>\n<li>Enfin, si aucun des cas précedents n'est rencontré, nous vérifions d'abord si nous sommes dans un échappement. Si c'est le cas, nous sommes dans le cas d'un faux positif (par exemple <code class=\"language-text\">\\a</code> représente bien les deux caractères car <code class=\"language-text\">a</code> ne peut pas être échappé). Nous ajoutons dans ce cas à notre tableau un token de type <code class=\"language-text\">T_STRING</code> ayant pour valeur <code class=\"language-text\">\\</code>. Pour finir, nous ajoutons le token courant à notre tableau et réinitialisons notre variable <code class=\"language-text\">escaping</code>.</li>\n</ul>\n</li>\n<li>Nous retournons ensuite notre liste de tokens en prenant soin de réaliser la fusion des tokens de type <code class=\"language-text\">T_STRING</code> comme expliqué précédemment.</li>\n</ul>\n<p>La fonction <code class=\"language-text\">mergeStringTokens()</code> consiste en un <code class=\"language-text\">reduce</code> trivial :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">mergeStringTokens</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tokens</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> tokens<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result<span class=\"token punctuation\">,</span> token</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      result<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">[</span>result<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">T_STRING</span>\n      <span class=\"token operator\">&amp;&amp;</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">T_STRING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> lastToken <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      lastToken<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+=</span> token<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n\n      result<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>lastToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      result<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Voilà, nous avons un lexeur fonctionnel, il est temps maintenant de passer au parseur !</p>\n<h2>Transformer un tableau de tokens en terms</h2>\n<p>Rappelez-vous le début de l'article, nous voulions pouvoir gérer du texte libre et des champs. C'est exactement le but de notre parseur. Il va recevoir en entrée notre tableau de tokens et va nous donner en sortie un tableau de terms. Prenons un exemple</p>\n<p>Consérons l'entrée suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">T<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">STRING(foo) T</span><span class=\"token punctuation\">_</span></span>SPACE T<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">STRING(bar) T</span><span class=\"token punctuation\">_</span></span>SYMBOL(:) T_STRING(hello)</code></pre></div>\n<p>La liste de terms que nous nous attendons à recevoir est la suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">TYPE<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">PLAIN(foo) TYPE</span><span class=\"token punctuation\">_</span></span>FIELD(bar, hello)</code></pre></div>\n<p>Comme pour notre lexeur, nous avons besoin de quelques helpers avant de commencer :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">TYPE_FIELD</span> <span class=\"token operator\">=</span> <span class=\"token string\">'TYPE_FIELD'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">TYPE_PLAIN</span> <span class=\"token operator\">=</span> <span class=\"token string\">'TYPE_PLAIN'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createTerm</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> key <span class=\"token operator\">?</span> <span class=\"token constant\">TYPE_FIELD</span> <span class=\"token punctuation\">:</span> <span class=\"token constant\">TYPE_PLAIN</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">,</span>\n    value<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">countOccurences</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tokens<span class=\"token punctuation\">,</span> char</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> tokens\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">typeof</span> token<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">count<span class=\"token punctuation\">,</span> token</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> count <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>\n      token<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>char<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isSymbolTerm</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token<span class=\"token punctuation\">,</span> symbol</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">T_SYMBOL</span> <span class=\"token operator\">&amp;&amp;</span> token<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> symbol<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nous définissons nos deux types de terms. Les autres fonctions sont explicites à l'exception de <code class=\"language-text\">countOccurences()</code> qui elle sert à compter le nombre d'apparitions d'un caractère dans un tableau de tokens.</p>\n<p>Afin de rendre le code du parseur plus maintenable et lisible, j'ai également implementé un buffer de tokens amélioré dont voici le code :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createTokenBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> storage <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      storage <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>storage<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      buffer<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>output<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> output<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result<span class=\"token punctuation\">,</span> token</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        result <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>result<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token punctuation\">.</span>value<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">:</span> token<span class=\"token punctuation\">.</span>value\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> storage<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">storage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>storage<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> storage<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">nextBuffer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      buffer<span class=\"token punctuation\">.</span>storage<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token</span> <span class=\"token operator\">=></span> nextBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      buffer<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> nextBuffer<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      storage<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> storage<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> buffer<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Ses fonctions sont assez explicites mis à part deux :</p>\n<ul>\n<li><code class=\"language-text\">flush()</code> va vider le buffer et retourner une chaine de caractère correspondant à la valeur de ses tokens.</li>\n<li><code class=\"language-text\">pipe()</code> va transférer le contenu du buffer dans un autre buffer.</li>\n</ul>\n<p>Ces bases mises en place, nous pouvons maintenant passer à l'implementation de notre parseur :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createTerms</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tokens</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> bufferValue <span class=\"token operator\">=</span> <span class=\"token function\">createTokenBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> bufferKey <span class=\"token operator\">=</span> <span class=\"token function\">createTokenBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> terms <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> tokens<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">T_SPACE</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>bufferValue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">||</span> bufferKey<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// we found a space xxxxx xxxx</span>\n      <span class=\"token comment\">//                  -----|----</span>\n      <span class=\"token comment\">//                       ^</span>\n      <span class=\"token comment\">//                   we are here</span>\n\n      terms<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createTerm</span><span class=\"token punctuation\">(</span>\n        bufferKey<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        bufferValue<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isSymbolTerm</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token string\">':'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">countOccurences</span><span class=\"token punctuation\">(</span>bufferValue<span class=\"token punctuation\">,</span> <span class=\"token string\">':'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token number\">0</span>\n    <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>bufferKey<span class=\"token punctuation\">.</span>length\n    <span class=\"token operator\">&amp;&amp;</span> bufferValue<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// we found a colon xxxxx:xxxx</span>\n      <span class=\"token comment\">//                  -----|----</span>\n      <span class=\"token comment\">//                       ^</span>\n      <span class=\"token comment\">//                   we are here</span>\n      <span class=\"token comment\">// to be valid, the current bufferValue can not contain any other colon</span>\n      <span class=\"token comment\">// and the bufferKey must be empty</span>\n      bufferValue<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>bufferKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token constant\">T_SPACE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// the current token has no effect, we just buffer it</span>\n      bufferValue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bufferValue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">||</span> bufferKey<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// if some data are buffered we must flush them</span>\n    terms<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">createTerm</span><span class=\"token punctuation\">(</span>\n      bufferKey<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      bufferValue<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> terms<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Etudions de plus près le code de notre parseur :</p>\n<ul>\n<li>Notre fonction <code class=\"language-text\">createTerms()</code> reçoit donc en entrée notre tableau de tokens, généré grâce à notre lexeur.</li>\n<li>\n<p>Nous initialisons ensuite, deux buffers :</p>\n<ul>\n<li><code class=\"language-text\">bufferValue</code> sera le buffer principal dans lequel les tokens seront ajoutés.</li>\n<li><code class=\"language-text\">bufferKey</code> servira à stocker la clé d'un champ.</li>\n</ul>\n</li>\n<li>\n<p>Nous parcourons donc notre tableau de tokens, et pour chaque token appliquons le raisonnement suivant :</p>\n<ul>\n<li>Si le token courant est de type <code class=\"language-text\">T_SPACE</code> et que l'un de nos buffers contient de la donnée alors nous créons un term avec le contenu de nos deux buffers. La condition sur la taille des buffers permet d'éviter de prendre en compte des espaces en double ou en début de requête.</li>\n<li>Si le token est de type <code class=\"language-text\">T_SYMBOL</code> et contient comme valeur <code class=\"language-text\">:</code> alors nous sommes peut être en présence d'un champ.\nPour en être sûr nous devons d'abord nous assurer que nous n'avons aucun <code class=\"language-text\">:</code> présent dans notre <code class=\"language-text\">bufferValue</code> (quelque soit son type afin de ne pas considérer <code class=\"language-text\">foo\\:bar:test</code> comme un champ ayant pour clé <code class=\"language-text\">foo:bar</code>).\nBien évidemment <code class=\"language-text\">bufferKey</code> doit être vide et enfin nous devons avoir de la donnée dans notre <code class=\"language-text\">bufferValue</code> afin de ne pas considérer un ensemble commençant par un <code class=\"language-text\">:</code> pour un champ.\nSi toutes ces conditions sont remplies nous transférons tout le contenu de <code class=\"language-text\">bufferValue</code> dans <code class=\"language-text\">bufferKey</code>.</li>\n<li>Dans tous les autres cas nous ajoutons le token courant à <code class=\"language-text\">bufferValue</code> si celui-ci n'est pas un espace.</li>\n</ul>\n</li>\n<li>Pour finir, si jamais nos buffers contiennent de la donnée, nous créons le dernier term.</li>\n</ul>\n<p>Notre parseur est maintenant complet à un détail près, nous avons oublié la gestion des expressions régulières. Comme cela ne concerne que la valeur de nos terms, il suffit de rajouter un <code class=\"language-text\">map</code> avant de retourner le résultat :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">return</span> terms<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">term</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> value <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> term<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> value <span class=\"token operator\">!==</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> term<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> fragments <span class=\"token operator\">=</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    fragments<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// we remove the first empty fragment as the string starts with /</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragments<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> term<span class=\"token punctuation\">;</span> <span class=\"token comment\">// regex pattern not found</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> flags <span class=\"token operator\">=</span> fragments<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>term<span class=\"token punctuation\">,</span>\n        value<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RegExp</span><span class=\"token punctuation\">(</span>fragments<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> term<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Le code étant explicite je ne m'attarderai pas dessus.</p>\n<p>Notre couple lexeur/parseur en place, nous sommes maintenant en mesure d'analyser notre requête !</p>\n<p>L'entrée suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">foo bar:test hello:/([0-9]+)/g : :world:test good:bad:worse planet\\:earth</code></pre></div>\n<p>Produira les terms suivants :</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">TYPE<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">PLAIN(foo)\nTYPE</span><span class=\"token punctuation\">_</span></span>FIELD(bar, test)\nTYPE<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">FIELD(hello, RegExp(([0-9]+)), 'g'))\nTYPE</span><span class=\"token punctuation\">_</span></span>PLAIN(:)\nTYPE<span class=\"token italic\"><span class=\"token punctuation\">_</span><span class=\"token content\">PLAIN(:world:test)\nTYPE</span><span class=\"token punctuation\">_</span></span>FIELD(good, bad:worse)\nTYPE_PLAIN(planet:earth)</code></pre></div>\n<p>Dans le cadre de notre projet, nous avons ensuite créer un filtre configurable se servant de cette liste de terms afin de réaliser un filtrage pertinent.</p>\n<h2>Conclusion</h2>\n<p>L'analyse syntaxique, même dans un périmètre très restreint permet de réaliser des solutions robustes et fiables. Le calcul est extrêmement rapide et les tests unitaires du lexeur et du parseur sont de surcroit très simples à implementer étant donné que les entrées sorties sont simples.\nComme nous avons pu le voir, des cas si simples ne nécessitent pas toujours l'utilisation d'une grammaire et d'un AST.</p>","frontmatter":{"date":"May 30, 2017","cover":"blog/analyse-syntaxique.jpg","title":"L'analyse syntaxique à la rescousse","meta_description":"Utiliser le pattern lexeur/parseur pour comprendre le contenu d'un champs de recherche"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"cover":"blog/analyse-syntaxique.jpg","title":"L'analyse syntaxique à la rescousse"}}}